<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Build123d Generator</title>
    
    <!-- 1. Pyodide (Python Engine) -->
    <script src="https://cdn.jsdelivr.net/pyodide/v0.29.0/full/pyodide.js"></script>

    <!-- 2. PDF Libraries -->
    <!-- Load jsPDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    
    <!-- 
       CRITICAL FIX: svg2pdf expects 'window.jsPDF' to exist to extend it.
       jsPDF 2.x puts it under 'window.jspdf.jsPDF', so we alias it here manually.
    -->
    <script>
        if (window.jspdf && window.jspdf.jsPDF) {
            window.jsPDF = window.jspdf.jsPDF;
        }
    </script>

    <!-- Load svg2pdf (Must be loaded AFTER the shim above) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/svg2pdf.js/2.2.1/svg2pdf.umd.min.js"></script>

    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; max-width: 900px; margin: 2rem auto; padding: 0 1rem; background: #f0f2f5; }
        .container { background: white; padding: 2rem; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); display: grid; grid-template-columns: 300px 1fr; gap: 2rem; }
        .status-bar { background: #e0f2fe; color: #0369a1; padding: 10px; border-radius: 6px; margin-bottom: 20px; font-weight: bold; text-align: center; border: 1px solid #bae6fd; }
        label { display: block; margin-top: 1rem; font-weight: 600; color: #4b5563; }
        input { width: 100%; padding: 8px; margin-top: 4px; border: 1px solid #d1d5db; border-radius: 4px; box-sizing: border-box; }
        button { width: 100%; margin-top: 20px; padding: 12px; border: none; border-radius: 6px; font-weight: bold; cursor: pointer; transition: background 0.2s; }
        #gen-btn { background: #2563eb; color: white; }
        #gen-btn:hover { background: #1d4ed8; }
        #gen-btn:disabled { background: #93c5fd; cursor: not-allowed; }
        
        .btn-group { display: flex; gap: 10px; margin-top: 10px; display: none; }
        .btn-group button { margin-top: 0; flex: 1; }
        #dl-svg { background: #10b981; color: white; }
        #dl-pdf { background: #ef4444; color: white; }

        #preview { border: 2px dashed #e5e7eb; display: flex; align-items: center; justify-content: center; min-height: 400px; background: #fafafa; border-radius: 8px; overflow: hidden; }
        svg { max-width: 100%; max-height: 100%; }
    </style>
</head>
<body>

    <h1>üìê Build123d Generator</h1>
    <div id="status" class="status-bar">‚è≥ Loading Python Engine...</div>

    <div class="container">
        <div class="controls">
            <label>Length (mm)</label>
            <input type="number" id="length" value="100">
            <label>Width (mm)</label>
            <input type="number" id="width" value="50">
            <label>Hole Radius (mm)</label>
            <input type="number" id="radius" value="10">

            <button id="gen-btn" disabled onclick="runGeneration()">Generate Diagram</button>
            
            <div id="dl-buttons" class="btn-group">
                <button id="dl-svg" onclick="downloadSVG()">SVG</button>
                <button id="dl-pdf" onclick="downloadPDF()">PDF</button>
            </div>
        </div>

        <div id="preview">
            <span style="color: #9ca3af;">Preview will appear here</span>
        </div>
    </div>

    <script>
        let pyodide = null;
        const statusEl = document.getElementById("status");
        const btnEl = document.getElementById("gen-btn");

        async function main() {
            try {
                // Initialize Pyodide
                pyodide = await loadPyodide();
                statusEl.innerText = "üì¶ Configuring Environment...";

                await pyodide.loadPackage("micropip");
                
                // Configure Environment
                await pyodide.runPythonAsync(`
                    import micropip
                    import js

                    print("1. Setting Index URLs...")
                    micropip.set_index_urls(["https://yeicor.github.io/OCP.wasm", "https://pypi.org/simple"])

                    print("2. Installing lib3mf...")
                    await micropip.install("lib3mf")
                    
                    print("3. Mocking py-lib3mf...")
                    micropip.add_mock_package("py-lib3mf", "2.4.1", modules={"py_lib3mf": '''from lib3mf import *'''})

                    print("4. Installing build123d & dependencies...")
                    await micropip.install(["build123d", "sqlite3", "svgpathtools", "numpy"])
                    
                    print("‚úÖ Packages Installed!")
                `);

                // Load Logic
                statusEl.innerText = "üêç Loading Logic...";
                const response = await fetch("./logic.py");
                
                if (!response.ok) {
                    throw new Error(`Could not fetch logic.py. If running locally, ensure run_web.py is used.`);
                }
                
                const logicCode = await response.text();
                pyodide.FS.writeFile("logic.py", logicCode);

                await pyodide.runPythonAsync(`
                    import logic
                    from logic import generate_plate_svg
                    print("‚úÖ Logic Loaded")
                `);

                statusEl.innerText = "‚úÖ Ready! Click Generate.";
                statusEl.style.background = "#dcfce7";
                statusEl.style.color = "#166534";
                statusEl.style.border = "1px solid #bbf7d0";
                btnEl.disabled = false;

            } catch (err) {
                statusEl.innerText = "‚ùå Error: " + err.message;
                statusEl.style.background = "#fee2e2";
                statusEl.style.color = "#991b1b";
                console.error(err);
            }
        }

        async function runGeneration() {
            const l = document.getElementById("length").value;
            const w = document.getElementById("width").value;
            const r = document.getElementById("radius").value;

            statusEl.innerText = "‚öôÔ∏è Generating...";
            
            try {
                const code = `logic.generate_plate_svg(${l}, ${w}, ${r})`;
                const svgContent = await pyodide.runPythonAsync(code);

                document.getElementById("preview").innerHTML = svgContent;
                
                // Show both download buttons
                document.getElementById("dl-buttons").style.display = "flex";
                
                statusEl.innerText = "‚úÖ Generated successfully";
            } catch (err) {
                alert("Generation Error: " + err.message);
                statusEl.innerText = "‚ùå Generation Failed";
                console.error(err);
            }
        }

        function downloadSVG() {
            const content = document.getElementById("preview").innerHTML;
            const blob = new Blob([content], {type: 'image/svg+xml'});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'diagram.svg';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
        }

        // --- PDF FUNCTION ---
        async function downloadPDF() {
            const svgElement = document.querySelector("#preview svg");
            
            if (!svgElement) {
                alert("Please generate a diagram first.");
                return;
            }

            try {
                // Ensure jsPDF constructor is available
                // window.jsPDF should now be populated by our shim in the <head>
                const doc = new window.jsPDF({
                    orientation: 'landscape',
                    unit: 'mm',
                    format: 'a4'
                });

                // Add SVG to PDF
                // svg2pdf extends the jsPDF object with .svg()
                await doc.svg(svgElement, {
                    x: 10,
                    y: 10,
                    width: 277,
                    height: 190
                });

                doc.save("diagram.pdf");
                
            } catch (err) {
                console.error(err);
                alert("PDF Generation failed: " + err.message);
            }
        }

        main();
    </script>
</body>
</html>