<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Instrument Neck Geometry Generator</title>
    
    <!-- Pyodide -->
    <script src="https://cdn.jsdelivr.net/pyodide/v0.29.0/full/pyodide.js"></script>

    <!-- SVG.js for zoom/pan -->
    <script src="https://cdn.jsdelivr.net/npm/@svgdotjs/svg.js@3.2.4/dist/svg.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@svgdotjs/svg.panzoom.js@2.1.2/dist/svg.panzoom.min.js"></script>

    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background: linear-gradient(135deg, #8B4513 0%, #D2691E 100%);
            min-height: 100vh;
            padding: 0.75rem;
        }
        
        .app-container {
            max-width: 1400px;
            margin: 0 auto;
        }
        
        header {
            text-align: center;
            color: white;
            margin-bottom: 0.5rem;
        }

        h1 {
            font-size: 1.5rem;
            margin: 0;
            text-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }

        .subtitle {
            display: none;
        }

        .status-bar {
            background: white;
            padding: 6px 12px;
            border-radius: 6px;
            margin-bottom: 0.75rem;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.3s ease;
            font-size: 0.85rem;
        }
        
        .status-bar.loading { background: #fef3c7; color: #92400e; border-left: 4px solid #f59e0b; }
        .status-bar.ready { background: #d1fae5; color: #065f46; border-left: 4px solid #10b981; }
        .status-bar.error { background: #fee2e2; color: #991b1b; border-left: 4px solid #ef4444; }
        .status-bar.generating { background: #dbeafe; color: #1e40af; border-left: 4px solid #3b82f6; }
        
        .spinner {
            width: 14px;
            height: 14px;
            border: 2px solid currentColor;
            border-top-color: transparent;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
            display: none;
        }
        
        .status-bar.loading .spinner,
        .status-bar.generating .spinner { display: block; }
        
        @keyframes spin { to { transform: rotate(360deg); } }
        
        .main-container {
            background: white;
            border-radius: 12px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
            display: grid;
            grid-template-columns: 315px 1fr;
            gap: 0;
            overflow: hidden;
            height: calc(100vh - 80px);
        }
        
        @media (max-width: 1024px) {
            .main-container {
                grid-template-columns: 1fr;
                max-height: none;
            }
        }
        
        .controls-panel {
            background: #f9fafb;
            padding: 0;
            border-right: 1px solid #e5e7eb;
            overflow-y: auto;
            height: 100%;
            display: flex;
            flex-direction: column;
        }

        .sticky-generate-section {
            position: sticky;
            top: 0;
            z-index: 10;
            background: #f9fafb;
            padding: 1rem 1.5rem;
            border-bottom: 2px solid #e5e7eb;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }

        .scrollable-params {
            padding: 1.5rem;
            flex: 1;
            overflow-y: auto;
        }

        .preset-selector {
            margin-top: 0.75rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .preset-selector label {
            font-weight: 600;
            color: #374151;
            font-size: 0.8rem;
            white-space: nowrap;
        }

        .preset-selector select {
            flex: 1;
            padding: 6px 8px;
            border: 2px solid #d1d5db;
            border-radius: 6px;
            font-size: 0.875rem;
        }

        .param-management {
            margin-top: 0.75rem;
        }

        .param-management-label {
            display: block;
            font-weight: 600;
            color: #374151;
            margin-bottom: 0.375rem;
            font-size: 0.8rem;
        }

        .param-buttons {
            display: flex;
            gap: 8px;
        }

        .param-btn {
            flex: 1;
            padding: 6px 10px;
            border: 2px solid #d1d5db;
            border-radius: 6px;
            background: white;
            font-weight: 600;
            font-size: 0.8rem;
            cursor: pointer;
            transition: all 0.2s;
            color: #374151;
        }

        .param-btn:hover {
            border-color: #8B4513;
            background: #f9fafb;
        }

        .param-btn-save {
            border-color: #10b981;
            color: #10b981;
        }

        .param-btn-save:hover {
            background: #d1fae5;
            border-color: #059669;
        }

        .param-btn-load {
            border-color: #3b82f6;
            color: #3b82f6;
        }

        .param-btn-load:hover {
            background: #dbeafe;
            border-color: #2563eb;
        }

        #load-params-input {
            display: none;
        }
        
        .category-section {
            margin-bottom: 1.5rem;
            background: white;
            border-radius: 8px;
            padding: 1rem;
            border: 1px solid #e5e7eb;
        }
        
        .category-title {
            font-weight: 700;
            color: #8B4513;
            margin-bottom: 0.75rem;
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            border-bottom: 2px solid #D2691E;
            padding-bottom: 0.5rem;
        }
        
        .param-group {
            margin-bottom: 1rem;
        }
        
        .param-group:last-child {
            margin-bottom: 0;
        }
        
        .param-label {
            display: flex;
            justify-content: space-between;
            align-items: baseline;
            margin-bottom: 0.4rem;
        }
        
        .param-label label {
            font-weight: 600;
            color: #374151;
            font-size: 0.85rem;
        }
        
        .param-unit {
            font-size: 0.75rem;
            color: #6b7280;
            font-weight: normal;
        }
        
        .param-description {
            font-size: 0.7rem;
            color: #6b7280;
            margin-top: 0.25rem;
            line-height: 1.3;
        }
        
        input[type="number"],
        input[type="range"],
        select {
            width: 100%;
            padding: 6px 8px;
            border: 2px solid #d1d5db;
            border-radius: 4px;
            font-size: 0.9rem;
            transition: border-color 0.2s;
        }
        
        input[type="number"]:focus,
        select:focus {
            outline: none;
            border-color: #8B4513;
        }
        
        input[type="range"] {
            padding: 0;
        }
        
        input[type="checkbox"] {
            width: 18px;
            height: 18px;
            margin-right: 8px;
        }
        
        .checkbox-group {
            display: flex;
            align-items: center;
        }
        
        .range-value {
            display: inline-block;
            min-width: 50px;
            text-align: right;
            font-size: 0.85rem;
            color: #374151;
            font-weight: 600;
        }
        
        .generate-btn {
            width: 100%;
            padding: 14px;
            background: linear-gradient(135deg, #8B4513 0%, #D2691E 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-weight: 700;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.2s;
            text-transform: uppercase;
            letter-spacing: 1px;
            box-shadow: 0 4px 6px rgba(139, 69, 19, 0.3);
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
        }

        .generate-btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(139, 69, 19, 0.4);
        }

        .generate-btn:disabled {
            background: #9ca3af;
            cursor: not-allowed;
            box-shadow: none;
        }

        .generate-btn-shortcut {
            font-size: 0.7rem;
            opacity: 0.9;
            text-transform: none;
            letter-spacing: 0.5px;
            font-weight: 400;
        }
        
        .download-buttons {
            display: flex;
            gap: 8px;
            align-items: center;
        }

        .download-buttons button {
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            font-weight: 600;
            cursor: pointer;
            font-size: 0.85rem;
            transition: all 0.2s;
        }

        .download-buttons button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .btn-svg {
            background: #10b981;
            color: white;
        }

        .btn-svg:hover:not(:disabled) {
            background: #059669;
        }

        .btn-pdf {
            background: #ef4444;
            color: white;
        }

        .btn-pdf:hover:not(:disabled) {
            background: #dc2626;
        }
        
        .preview-panel {
            padding: 2rem;
            display: flex;
            flex-direction: column;
            background: #fafafa;
            height: 100%;
            overflow: hidden;
        }

        .view-controls-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
            gap: 1rem;
        }

        .view-tabs {
            display: flex;
            gap: 10px;
            flex: 1;
        }

        .view-tab {
            flex: 1;
            padding: 10px 16px;
            background: white;
            border: 2px solid #d1d5db;
            border-radius: 6px;
            font-weight: 600;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.2s;
            color: #6b7280;
        }

        .view-tab:hover {
            border-color: #8B4513;
            background: #f9fafb;
        }

        .view-tab.active {
            background: linear-gradient(135deg, #8B4513 0%, #D2691E 100%);
            color: white;
            border-color: #8B4513;
        }

        .zoom-controls {
            display: flex;
            gap: 8px;
        }

        .zoom-btn {
            padding: 6px 12px;
            background: white;
            border: 2px solid #d1d5db;
            border-radius: 4px;
            font-weight: 600;
            font-size: 0.85rem;
            cursor: pointer;
            transition: all 0.2s;
            min-width: 36px;
        }

        .zoom-btn:hover {
            border-color: #8B4513;
            background: #f9fafb;
        }

        #preview-container {
            flex: 1;
            border: 2px dashed #d1d5db;
            border-radius: 8px;
            background: white;
            min-height: 400px;
            overflow: hidden;
            position: relative;
            display: flex;
        }

        #preview-container.has-content {
            border-style: solid;
            border-color: #8B4513;
        }

        #preview-container .preview-placeholder {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
        }

        /* SVG.js canvas should fill container */
        #preview-container > svg {
            width: 100% !important;
            height: 100% !important;
            display: block;
        }
        
        .preview-placeholder {
            text-align: center;
            color: #9ca3af;
            padding: 2rem;
        }
        
        .preview-placeholder svg {
            width: 80px;
            height: 80px;
            margin-bottom: 1rem;
            opacity: 0.3;
        }
        
        .error-panel {
            background: #fee2e2;
            border: 2px solid #fecaca;
            border-radius: 8px;
            padding: 1rem;
            margin-top: 1rem;
            display: none;
        }
        
        .error-panel.show {
            display: block;
        }
        
        .error-panel h3 {
            color: #991b1b;
            font-size: 0.9rem;
            margin-bottom: 0.5rem;
        }
        
        .error-panel ul {
            list-style: none;
            padding: 0;
        }
        
        .error-panel li {
            color: #7f1d1d;
            font-size: 0.85rem;
            padding: 0.25rem 0;
            padding-left: 1.5rem;
            position: relative;
        }
        
        .error-panel li:before {
            content: "‚Ä¢";
            position: absolute;
            left: 0.5rem;
        }

        @media (max-width: 1200px) {
            .view-controls-header {
                flex-wrap: wrap;
            }

            .view-tabs {
                flex: 1 1 100%;
                margin-bottom: 0.5rem;
            }

            .zoom-controls,
            .download-buttons {
                flex: 0 0 auto;
            }
        }
    </style>
</head>
<body>
    <div class="app-container">
        <header>
            <h1>üéª Instrument Neck Geometry Generator</h1>
            <p class="subtitle">Parametric CAD for Lutherie - Design precise neck templates based on historical and modern measurements</p>
        </header>

        <div id="status" class="status-bar loading">
            <div class="spinner"></div>
            <span id="status-text">Initializing Python environment...</span>
        </div>

        <div class="main-container">
            <div class="controls-panel">
                <div class="sticky-generate-section">
                    <button class="generate-btn" id="gen-btn" disabled onclick="generateNeck()">
                        <span>Generate Template</span>
                        <span class="generate-btn-shortcut" id="gen-btn-shortcut">‚åò/Ctrl + Enter</span>
                    </button>

                    <div class="preset-selector">
                        <label for="preset">Presets:</label>
                        <select id="preset" onchange="loadPreset()">
                            <option value="">-- Custom --</option>
                        </select>
                    </div>

                    <div class="param-management">
                        <span class="param-management-label">Parameters</span>
                        <div class="param-buttons">
                            <button class="param-btn param-btn-save" onclick="saveParameters()">üíæ Save</button>
                            <button class="param-btn param-btn-load" onclick="document.getElementById('load-params-input').click()">üìÇ Load</button>
                            <input type="file" id="load-params-input" accept=".json" onchange="loadParameters(event)" />
                        </div>
                    </div>
                </div>

                <div class="scrollable-params">
                    <div id="parameters-container">
                        <!-- Parameters will be generated here -->
                    </div>

                    <div id="error-panel" class="error-panel">
                        <h3>‚ö†Ô∏è Validation Errors</h3>
                        <ul id="error-list"></ul>
                    </div>
                </div>
            </div>

            <div class="preview-panel">
                <div class="view-controls-header">
                    <div id="view-tabs" class="view-tabs">
                        <button class="view-tab active" data-view="side" onclick="switchView('side')">
                            Side View
                        </button>
                        <button class="view-tab" data-view="top" onclick="switchView('top')">
                            Top View
                        </button>
                        <button class="view-tab" data-view="cross_section" onclick="switchView('cross_section')">
                            Cross-Section
                        </button>
                    </div>

                    <div id="zoom-controls" class="zoom-controls">
                        <button class="zoom-btn" onclick="zoomIn()" title="Zoom In">+</button>
                        <button class="zoom-btn" onclick="zoomOut()" title="Zoom Out">‚àí</button>
                        <button class="zoom-btn" onclick="zoomReset()" title="Reset View">‚ü≤</button>
                    </div>

                    <div id="download-buttons" class="download-buttons">
                        <button class="btn-svg" id="dl-svg" onclick="downloadSVG()" disabled>üì• SVG</button>
                        <button class="btn-pdf" id="dl-pdf" onclick="downloadPDF()" disabled>üìÑ PDF</button>
                    </div>
                </div>

                <div id="preview-container">
                    <div class="preview-placeholder">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M12 2L2 7v10c0 5.55 3.84 10.74 9 12 5.16-1.26 9-6.45 9-12V7l-10-5z"/>
                            <circle cx="12" cy="12" r="3"/>
                        </svg>
                        <div style="font-size: 1.1rem; font-weight: 600; margin-bottom: 0.5rem;">
                            Neck Template Preview
                        </div>
                        <div style="font-size: 0.9rem;">
                            Adjust parameters and click Generate
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Application Script -->
    <script>
        // Global state (exposed to window for PDF module)
        window.state = {
            pyodide: null,
            isGenerating: false,
            views: null,              // Stores all 3 SVG views
            currentView: 'side',      // Currently displayed view (default to side)
            svgCanvas: null,          // SVG.js canvas for zoom/pan
            initialViewBox: null,     // Initial viewBox for zoom reset
            parameterDefinitions: null,
            presets: null
        };

        const state = window.state;  // Local reference

        const elements = {
            status: document.getElementById('status'),
            statusText: document.getElementById('status-text'),
            genBtn: document.getElementById('gen-btn'),
            preview: document.getElementById('preview-container'),
            errorPanel: document.getElementById('error-panel'),
            errorList: document.getElementById('error-list'),
            parametersContainer: document.getElementById('parameters-container'),
            presetSelect: document.getElementById('preset'),
            viewTabs: document.getElementById('view-tabs'),
            zoomControls: document.getElementById('zoom-controls'),
            dlSvg: document.getElementById('dl-svg'),
            dlPdf: document.getElementById('dl-pdf')
        };

        function setStatus(type, message) {
            elements.status.className = `status-bar ${type}`;
            elements.statusText.textContent = message;
        }

        function showErrors(errors) {
            elements.errorList.innerHTML = errors.map(e => `<li>${e}</li>`).join('');
            elements.errorPanel.classList.add('show');
        }

        function hideErrors() {
            elements.errorPanel.classList.remove('show');
        }

        async function initializePython() {
            try {
                setStatus('loading', 'Loading Python engine...');
                state.pyodide = await loadPyodide();

                setStatus('loading', 'Installing package manager...');
                await state.pyodide.loadPackage('micropip');
                
                setStatus('loading', 'Installing CAD libraries (this may take 1-2 minutes)...');
                await state.pyodide.runPythonAsync(`
                    import micropip
                    
                    micropip.set_index_urls([
                        "https://yeicor.github.io/OCP.wasm",
                        "https://pypi.org/simple"
                    ])
                    
                    await micropip.install("lib3mf")
                    micropip.add_mock_package(
                        "py-lib3mf", 
                        "2.4.1", 
                        modules={"py_lib3mf": "from lib3mf import *"}
                    )
                    
                    await micropip.install([
                        "build123d",
                        "sqlite3",
                        "svgpathtools",
                        "numpy"
                    ])
                    
                    print("‚úÖ Packages installed")
                `);

                setStatus('loading', 'Loading instrument neck modules...');
                
                // Load Python modules
                const modules = ['instrument_parameters.py', 'instrument_geometry.py', 'instrument_generator.py'];
                
                for (const moduleName of modules) {
                    let response = await fetch(`./${moduleName}`);
                    if (!response.ok) {
                        response = await fetch(`../src/${moduleName}`);
                    }
                    if (!response.ok) {
                        throw new Error(`Could not find ${moduleName}`);
                    }
                    
                    const code = await response.text();
                    state.pyodide.FS.writeFile(moduleName, code);
                }

                // Import modules
                await state.pyodide.runPythonAsync(`
                    import instrument_parameters
                    import instrument_geometry
                    import instrument_generator
                    print("‚úÖ Modules loaded")
                `);

                // Get parameter definitions
                setStatus('loading', 'Building interface...');
                const paramDefsJson = await state.pyodide.runPythonAsync(`
                    from instrument_generator import get_parameter_definitions
                    get_parameter_definitions()
                `);
                
                state.parameterDefinitions = JSON.parse(paramDefsJson);
                
                // Get presets
                const presetsJson = await state.pyodide.runPythonAsync(`
                    from instrument_generator import get_presets
                    get_presets()
                `);
                
                state.presets = JSON.parse(presetsJson);
                
                // Generate UI
                generateUI();
                populatePresets();

                setStatus('ready', '‚úÖ Ready! Adjust parameters and generate your template');
                elements.genBtn.disabled = false;

            } catch (error) {
                setStatus('error', '‚ùå Initialization failed');
                showErrors([`Failed to initialize: ${error.message}`]);
                console.error('Initialization error:', error);
            }
        }

        function generateUI() {
            const container = elements.parametersContainer;
            container.innerHTML = '';

            const categories = state.parameterDefinitions.categories;
            const parameters = state.parameterDefinitions.parameters;

            for (const category of categories) {
                const section = document.createElement('div');
                section.className = 'category-section';
                
                const title = document.createElement('div');
                title.className = 'category-title';
                title.textContent = category;
                section.appendChild(title);

                for (const [name, param] of Object.entries(parameters)) {
                    if (param.category === category) {
                        section.appendChild(createParameterControl(name, param));
                    }
                }

                container.appendChild(section);
            }
        }

        function createParameterControl(name, param) {
            const group = document.createElement('div');
            group.className = 'param-group';

            if (param.type === 'number') {
                const labelDiv = document.createElement('div');
                labelDiv.className = 'param-label';
                
                const label = document.createElement('label');
                label.textContent = param.label;
                label.htmlFor = name;
                
                const unit = document.createElement('span');
                unit.className = 'param-unit';
                unit.textContent = param.unit;
                
                labelDiv.appendChild(label);
                labelDiv.appendChild(unit);
                group.appendChild(labelDiv);

                const input = document.createElement('input');
                input.type = 'number';
                input.id = name;
                input.name = name;
                input.value = param.default;
                input.min = param.min;
                input.max = param.max;
                input.step = param.step;
                input.addEventListener('change', hideErrors);
                group.appendChild(input);

            } else if (param.type === 'enum') {
                const labelDiv = document.createElement('div');
                labelDiv.className = 'param-label';
                
                const label = document.createElement('label');
                label.textContent = param.label;
                label.htmlFor = name;
                labelDiv.appendChild(label);
                group.appendChild(labelDiv);

                const select = document.createElement('select');
                select.id = name;
                select.name = name;
                
                for (const option of param.options) {
                    const opt = document.createElement('option');
                    opt.value = option.value;
                    opt.textContent = option.label;
                    if (option.value === param.default) {
                        opt.selected = true;
                    }
                    select.appendChild(opt);
                }
                
                select.addEventListener('change', hideErrors);
                group.appendChild(select);

            } else if (param.type === 'boolean') {
                const checkboxDiv = document.createElement('div');
                checkboxDiv.className = 'checkbox-group';
                
                const input = document.createElement('input');
                input.type = 'checkbox';
                input.id = name;
                input.name = name;
                input.checked = param.default;
                input.addEventListener('change', hideErrors);
                
                const label = document.createElement('label');
                label.textContent = param.label;
                label.htmlFor = name;
                
                checkboxDiv.appendChild(input);
                checkboxDiv.appendChild(label);
                group.appendChild(checkboxDiv);
            }

            if (param.description) {
                const desc = document.createElement('div');
                desc.className = 'param-description';
                desc.textContent = param.description;
                group.appendChild(desc);
            }

            return group;
        }

        function populatePresets() {
            const select = elements.presetSelect;
            
            for (const [name, values] of Object.entries(state.presets)) {
                const option = document.createElement('option');
                option.value = name;
                option.textContent = name.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
                select.appendChild(option);
            }
        }

        function loadPreset() {
            const presetName = elements.presetSelect.value;
            if (!presetName) return;

            const preset = state.presets[presetName];
            if (!preset) return;

            // Apply preset values
            for (const [name, value] of Object.entries(preset)) {
                const element = document.getElementById(name);
                if (element) {
                    if (element.type === 'checkbox') {
                        element.checked = value;
                    } else {
                        element.value = value;
                    }
                }
            }

            hideErrors();
        }

        function collectParameters() {
            const params = {};
            
            for (const [name, param] of Object.entries(state.parameterDefinitions.parameters)) {
                const element = document.getElementById(name);
                if (!element) continue;

                if (param.type === 'number') {
                    params[name] = parseFloat(element.value);
                } else if (param.type === 'boolean') {
                    params[name] = element.checked;
                } else if (param.type === 'enum') {
                    params[name] = element.value;
                }
            }

            return params;
        }

        async function generateNeck() {
            if (state.isGenerating) return;

            hideErrors();
            state.isGenerating = true;
            elements.genBtn.disabled = true;

            setStatus('generating', '‚öôÔ∏è Generating neck templates (all views)...');

            try {
                const params = collectParameters();
                const paramsJson = JSON.stringify(params);

                const resultJson = await state.pyodide.runPythonAsync(`
                    from instrument_generator import generate_violin_neck
                    generate_violin_neck('${paramsJson.replace(/'/g, "\\'")}')
                `);

                const result = JSON.parse(resultJson);

                if (result.success) {
                    // Store all views
                    state.views = result.views;

                    // Display current view
                    displayCurrentView();

                    // Enable download buttons
                    elements.dlSvg.disabled = false;
                    elements.dlPdf.disabled = false;
                    elements.preview.classList.add('has-content');

                    setStatus('ready', '‚úÖ Templates generated successfully! Use tabs to switch views.');
                } else {
                    showErrors(result.errors);
                    setStatus('error', '‚ùå Generation failed - see errors below');
                }

            } catch (error) {
                showErrors([`Unexpected error: ${error.message}`]);
                setStatus('error', '‚ùå Generation failed');
                console.error('Generation error:', error);
            } finally {
                state.isGenerating = false;
                elements.genBtn.disabled = false;
            }
        }

        function displayCurrentView() {
            if (!state.views || !state.views[state.currentView]) {
                console.error('No view available for:', state.currentView);
                return;
            }

            // Clear previous canvas
            if (state.svgCanvas) {
                state.svgCanvas.clear();
                state.svgCanvas.remove();
                state.svgCanvas = null;
            }

            // Clear container
            elements.preview.innerHTML = '';

            // Create SVG.js canvas (CSS handles sizing with width/height 100%)
            state.svgCanvas = SVG()
                .addTo('#preview-container');

            // Load the SVG content
            state.svgCanvas.svg(state.views[state.currentView]);

            // Get the bounding box of all content before enabling pan/zoom
            // We need to do this first to get accurate bbox
            const bbox = state.svgCanvas.bbox();

            // Get container dimensions
            const containerRect = elements.preview.getBoundingClientRect();

            // Calculate padding (5% of smallest dimension)
            const paddingPercent = 0.05;
            const minDim = Math.min(containerRect.width, containerRect.height);
            const padding = minDim * paddingPercent;

            // Set viewBox to fit content with padding
            const viewBoxConfig = {
                x: bbox.x - padding,
                y: bbox.y - padding,
                width: bbox.width + padding * 2,
                height: bbox.height + padding * 2
            };

            state.svgCanvas.viewbox(
                viewBoxConfig.x,
                viewBoxConfig.y,
                viewBoxConfig.width,
                viewBoxConfig.height
            );

            // Store the initial viewBox for reset
            state.initialViewBox = viewBoxConfig;

            // Enable pan/zoom after setting the viewBox
            state.svgCanvas.panZoom({
                zoomMin: 0.1,
                zoomMax: 20,
                zoomFactor: 0.3
            });

            // Update tab highlighting
            document.querySelectorAll('.view-tab').forEach(tab => {
                if (tab.dataset.view === state.currentView) {
                    tab.classList.add('active');
                } else {
                    tab.classList.remove('active');
                }
            });
        }

        function switchView(viewName) {
            if (!state.views) {
                console.error('No views generated yet');
                return;
            }

            state.currentView = viewName;
            displayCurrentView();
        }

        function zoomIn() {
            if (state.svgCanvas) {
                state.svgCanvas.zoom(state.svgCanvas.zoom() * 1.3);
            }
        }

        function zoomOut() {
            if (state.svgCanvas) {
                state.svgCanvas.zoom(state.svgCanvas.zoom() / 1.3);
            }
        }

        function zoomReset() {
            if (state.svgCanvas && state.initialViewBox) {
                // Reset to the initial fitted viewBox (this automatically fits to viewport)
                state.svgCanvas.viewbox(
                    state.initialViewBox.x,
                    state.initialViewBox.y,
                    state.initialViewBox.width,
                    state.initialViewBox.height
                );
            }
        }

        function downloadSVG() {
            if (!state.views || !state.views[state.currentView]) {
                alert('Please generate a template first.');
                return;
            }

            const viewNames = {
                'side': 'side-view',
                'top': 'top-view',
                'cross_section': 'cross-section'
            };

            const svgContent = state.views[state.currentView];
            const blob = new Blob([svgContent], { type: 'image/svg+xml' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `instrument_neck_${viewNames[state.currentView]}.svg`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        function downloadPDF() {
            if (!state.views || !state.views[state.currentView]) {
                alert('Please generate a template first.');
                return;
            }

            // PDF download will use the current view
            alert('PDF export will be updated to download current view');
        }

        function saveParameters() {
            const params = collectParameters();

            const saveData = {
                metadata: {
                    version: '1.0',
                    timestamp: new Date().toISOString(),
                    description: 'Instrument Neck Parameters',
                    generator: 'Instrument Neck Geometry Generator'
                },
                parameters: params
            };

            const jsonString = JSON.stringify(saveData, null, 2);
            const blob = new Blob([jsonString], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            const timestamp = new Date().toISOString().replace(/[:.]/g, '-').slice(0, -5);
            a.download = `instrument_params_${timestamp}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        function loadParameters(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const saveData = JSON.parse(e.target.result);

                    // Validate structure
                    if (!saveData.parameters) {
                        alert('Invalid parameters file: missing parameters object');
                        return;
                    }

                    // Apply loaded values
                    const params = saveData.parameters;
                    for (const [name, value] of Object.entries(params)) {
                        const element = document.getElementById(name);
                        if (element) {
                            if (element.type === 'checkbox') {
                                element.checked = value;
                            } else {
                                element.value = value;
                            }
                        }
                    }

                    // Reset preset selector
                    elements.presetSelect.value = '';

                    hideErrors();
                    setStatus('ready', '‚úÖ Parameters loaded successfully');

                } catch (error) {
                    alert(`Failed to load parameters: ${error.message}`);
                }
            };
            reader.readAsText(file);

            // Reset file input so the same file can be loaded again
            event.target.value = '';
        }

        // Keyboard shortcut handler
        document.addEventListener('keydown', (e) => {
            if ((e.metaKey || e.ctrlKey) && e.key === 'Enter') {
                e.preventDefault();
                if (!elements.genBtn.disabled && !state.isGenerating) {
                    generateNeck();
                }
            }
        });

        // Detect OS and update shortcut display
        (function updateShortcutDisplay() {
            const isMac = navigator.platform.toUpperCase().indexOf('MAC') >= 0;
            const shortcutElement = document.getElementById('gen-btn-shortcut');
            if (shortcutElement) {
                shortcutElement.textContent = isMac ? '‚åò + Enter' : 'Ctrl + Enter';
            }
        })();

        // Window resize is handled automatically by CSS (width/height 100%)

        // Initialize on load
        initializePython();
    </script>

    <!-- PDF Export (optional) -->
    <script type="module">
        import { jsPDF } from "https://cdn.jsdelivr.net/npm/jspdf@2.5.1/+esm";
        import { svg2pdf } from "https://cdn.jsdelivr.net/npm/svg2pdf.js@2.2.4/+esm";

        window.downloadPDF = async function() {
            if (!window.state || !window.state.views || !window.state.views[window.state.currentView]) {
                alert('Please generate a template first.');
                return;
            }

            try {
                // Use the raw SVG content from state, not the DOM element
                const svgContent = window.state.views[window.state.currentView];

                // Create a temporary SVG element from the raw content
                const parser = new DOMParser();
                const svgDoc = parser.parseFromString(svgContent, 'image/svg+xml');
                const svgElement = svgDoc.documentElement;

                // Get SVG dimensions from viewBox or width/height attributes
                let svgWidth, svgHeight;
                const viewBox = svgElement.getAttribute('viewBox');

                if (viewBox) {
                    const [, , width, height] = viewBox.split(/\s+/).map(parseFloat);
                    svgWidth = width;
                    svgHeight = height;
                } else {
                    svgWidth = parseFloat(svgElement.getAttribute('width')) || 210;
                    svgHeight = parseFloat(svgElement.getAttribute('height')) || 297;
                }

                // ISO A sizes (width x height in mm)
                const isoSizes = [
                    { name: 'a4', width: 210, height: 297 },
                    { name: 'a3', width: 297, height: 420 },
                    { name: 'a2', width: 420, height: 594 },
                    { name: 'a1', width: 594, height: 841 },
                    { name: 'a0', width: 841, height: 1189 }
                ];

                // Add margins (20mm on each side)
                const margin = 20;
                const requiredWidth = svgWidth + (margin * 2);
                const requiredHeight = svgHeight + (margin * 2);

                // Find the smallest ISO A size that fits the content
                // Try both portrait and landscape orientations
                let selectedFormat = null;
                let selectedOrientation = 'portrait';

                for (const size of isoSizes) {
                    // Try portrait
                    if (size.width >= requiredWidth && size.height >= requiredHeight) {
                        selectedFormat = size;
                        selectedOrientation = 'portrait';
                        break;
                    }
                    // Try landscape
                    if (size.height >= requiredWidth && size.width >= requiredHeight) {
                        selectedFormat = size;
                        selectedOrientation = 'landscape';
                        break;
                    }
                }

                // Fallback to A0 landscape if content is too large
                if (!selectedFormat) {
                    selectedFormat = isoSizes[4]; // A0
                    selectedOrientation = 'landscape';
                    console.warn('Content too large for A0, using A0 landscape with scaling');
                }

                // Create PDF with selected size and orientation
                const doc = new jsPDF({
                    orientation: selectedOrientation,
                    unit: 'mm',
                    format: selectedFormat.name
                });

                // Get page dimensions
                const pageWidth = doc.internal.pageSize.getWidth();
                const pageHeight = doc.internal.pageSize.getHeight();

                // Center the SVG on the page with margins
                const x = (pageWidth - svgWidth) / 2;
                const y = (pageHeight - svgHeight) / 2;

                // Convert SVG to PDF at 1:1 scale (1mm SVG = 1mm PDF)
                await svg2pdf(svgElement, doc, {
                    x: x,
                    y: y,
                    width: svgWidth,
                    height: svgHeight
                });

                const viewNames = {
                    'top': 'top-view',
                    'side': 'side-view',
                    'cross_section': 'cross-section'
                };

                const currentView = window.state.currentView;
                console.log(`PDF: ${selectedFormat.name.toUpperCase()} ${selectedOrientation}, SVG size: ${svgWidth}x${svgHeight}mm`);
                doc.save(`instrument_neck_${viewNames[currentView]}_${selectedFormat.name}.pdf`);

            } catch (error) {
                console.error('PDF error:', error);
                alert(`PDF generation failed: ${error.message}`);
            }
        };
    </script>
</body>
</html>