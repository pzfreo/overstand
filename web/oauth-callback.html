<!DOCTYPE html>
<html><head><title>Signing in...</title></head>
<body>
<div id="msg" style="font-family:system-ui;padding:40px;text-align:center;color:#666;">
  Signing in...
</div>
<script>
(function() {
    var el = document.getElementById('msg');

    // Supabase may return tokens in the hash (implicit flow) or code in the query (PKCE)
    var hashParams = new URLSearchParams(window.location.hash.substring(1));
    var queryParams = new URLSearchParams(window.location.search);

    var accessToken = hashParams.get('access_token');
    var refreshToken = hashParams.get('refresh_token');
    var code = queryParams.get('code');

    if (accessToken && refreshToken) {
        // Implicit flow — pass tokens to opener via localStorage
        try {
            localStorage.setItem('oauth-result', JSON.stringify({
                access_token: accessToken,
                refresh_token: refreshToken
            }));
            el.textContent = 'Signed in! Closing...';
        } catch(e) {
            el.textContent = 'Storage error: ' + e.message;
            return;
        }
    } else if (code) {
        // PKCE flow — pass code to opener via localStorage
        try {
            localStorage.setItem('oauth-result', JSON.stringify({ code: code }));
            el.textContent = 'Signed in! Closing...';
        } catch(e) {
            el.textContent = 'Storage error: ' + e.message;
            return;
        }
    } else {
        el.textContent = 'Sign-in error: no credentials received.';
        // Redirect to main page after a moment
        setTimeout(function() { window.location.href = './'; }, 2000);
        return;
    }

    // Close popup, or redirect to main page if not a popup
    setTimeout(function() {
        try { window.close(); } catch(e) {}
        setTimeout(function() { window.location.href = './'; }, 500);
    }, 300);
})();
</script>
</body>
</html>
