<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Build123d Diagram Generator</title>
    
    <!-- Pyodide (Python in WebAssembly) -->
    <script src="https://cdn.jsdelivr.net/pyodide/v0.29.0/full/pyodide.js"></script>

    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 2rem 1rem;
        }
        
        .app-container {
            max-width: 1200px;
            margin: 0 auto;
        }
        
        h1 {
            color: white;
            text-align: center;
            margin-bottom: 1rem;
            font-size: 2rem;
            text-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        
        .subtitle {
            color: rgba(255,255,255,0.9);
            text-align: center;
            margin-bottom: 2rem;
            font-size: 0.95rem;
        }
        
        .status-bar {
            background: white;
            padding: 12px 20px;
            border-radius: 8px;
            margin-bottom: 1.5rem;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            display: flex;
            align-items: center;
            gap: 10px;
            transition: all 0.3s ease;
        }
        
        .status-bar.loading {
            background: #fef3c7;
            color: #92400e;
            border-left: 4px solid #f59e0b;
        }
        
        .status-bar.ready {
            background: #d1fae5;
            color: #065f46;
            border-left: 4px solid #10b981;
        }
        
        .status-bar.error {
            background: #fee2e2;
            color: #991b1b;
            border-left: 4px solid #ef4444;
        }
        
        .status-bar.generating {
            background: #dbeafe;
            color: #1e40af;
            border-left: 4px solid #3b82f6;
        }
        
        .spinner {
            width: 16px;
            height: 16px;
            border: 2px solid currentColor;
            border-top-color: transparent;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
            display: none;
        }
        
        .status-bar.loading .spinner,
        .status-bar.generating .spinner {
            display: block;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .container {
            background: white;
            border-radius: 12px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            display: grid;
            grid-template-columns: 320px 1fr;
            gap: 0;
            overflow: hidden;
        }
        
        @media (max-width: 768px) {
            .container {
                grid-template-columns: 1fr;
            }
        }
        
        .controls {
            background: #f9fafb;
            padding: 2rem;
            border-right: 1px solid #e5e7eb;
        }
        
        .form-group {
            margin-bottom: 1.5rem;
        }
        
        label {
            display: block;
            font-weight: 600;
            color: #374151;
            margin-bottom: 0.5rem;
            font-size: 0.875rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .input-group {
            position: relative;
        }
        
        input {
            width: 100%;
            padding: 10px 12px;
            border: 2px solid #d1d5db;
            border-radius: 6px;
            font-size: 1rem;
            transition: all 0.2s;
        }
        
        input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        
        input:invalid {
            border-color: #ef4444;
        }
        
        .input-hint {
            font-size: 0.75rem;
            color: #6b7280;
            margin-top: 0.25rem;
        }
        
        .validation-error {
            color: #dc2626;
            font-size: 0.75rem;
            margin-top: 0.25rem;
            display: none;
        }
        
        .validation-error.show {
            display: block;
        }
        
        button {
            width: 100%;
            padding: 12px;
            border: none;
            border-radius: 6px;
            font-weight: 600;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.2s;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        #gen-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            box-shadow: 0 4px 6px rgba(102, 126, 234, 0.3);
        }
        
        #gen-btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(102, 126, 234, 0.4);
        }
        
        #gen-btn:disabled {
            background: #9ca3af;
            cursor: not-allowed;
            box-shadow: none;
        }
        
        .btn-group {
            display: none;
            gap: 10px;
            margin-top: 1rem;
        }
        
        .btn-group.show {
            display: flex;
        }
        
        .btn-group button {
            flex: 1;
            padding: 10px;
            font-size: 0.875rem;
        }
        
        #dl-svg {
            background: #10b981;
            color: white;
        }
        
        #dl-svg:hover {
            background: #059669;
        }
        
        #dl-pdf {
            background: #ef4444;
            color: white;
        }
        
        #dl-pdf:hover {
            background: #dc2626;
        }
        
        .preview-container {
            padding: 2rem;
            display: flex;
            flex-direction: column;
            min-height: 500px;
        }
        
        #preview {
            border: 2px dashed #e5e7eb;
            border-radius: 8px;
            background: #fafafa;
            display: flex;
            align-items: center;
            justify-content: center;
            flex: 1;
            overflow: hidden;
            position: relative;
        }
        
        #preview.has-content {
            border-style: solid;
            border-color: #d1d5db;
        }
        
        #preview svg {
            max-width: 100%;
            max-height: 100%;
            filter: drop-shadow(0 4px 6px rgba(0,0,0,0.1));
        }
        
        .preview-placeholder {
            text-align: center;
            color: #9ca3af;
            padding: 2rem;
        }
        
        .preview-placeholder svg {
            width: 64px;
            height: 64px;
            margin-bottom: 1rem;
            opacity: 0.3;
        }
        
        .error-details {
            background: #fef2f2;
            border: 1px solid #fecaca;
            border-radius: 6px;
            padding: 1rem;
            margin-top: 1rem;
            display: none;
        }
        
        .error-details.show {
            display: block;
        }
        
        .error-details h3 {
            color: #991b1b;
            font-size: 0.875rem;
            margin-bottom: 0.5rem;
        }
        
        .error-details p {
            color: #7f1d1d;
            font-size: 0.8rem;
            line-height: 1.5;
        }
    </style>
</head>
<body>
    <div class="app-container">
        <h1>üîß Build123d Diagram Generator</h1>
        <p class="subtitle">Create parametric 2D CAD diagrams in your browser</p>

        <div id="status" class="status-bar loading">
            <div class="spinner"></div>
            <span id="status-text">Initializing Python engine...</span>
        </div>

        <div class="container">
            <div class="controls">
                <div class="form-group">
                    <label for="length">Length (mm)</label>
                    <div class="input-group">
                        <input 
                            type="number" 
                            id="length" 
                            value="100" 
                            min="0.1" 
                            max="10000" 
                            step="0.1"
                            required
                        >
                    </div>
                    <div class="input-hint">Recommended: 10-1000mm</div>
                    <div class="validation-error" id="length-error"></div>
                </div>

                <div class="form-group">
                    <label for="width">Width (mm)</label>
                    <div class="input-group">
                        <input 
                            type="number" 
                            id="width" 
                            value="50" 
                            min="0.1" 
                            max="10000" 
                            step="0.1"
                            required
                        >
                    </div>
                    <div class="input-hint">Recommended: 10-1000mm</div>
                    <div class="validation-error" id="width-error"></div>
                </div>

                <div class="form-group">
                    <label for="radius">Hole Radius (mm)</label>
                    <div class="input-group">
                        <input 
                            type="number" 
                            id="radius" 
                            value="10" 
                            min="0.1" 
                            max="5000" 
                            step="0.1"
                            required
                        >
                    </div>
                    <div class="input-hint">Must fit within plate dimensions</div>
                    <div class="validation-error" id="radius-error"></div>
                </div>

                <button id="gen-btn" disabled onclick="runGeneration()">
                    Generate Diagram
                </button>
                
                <div id="dl-buttons" class="btn-group">
                    <button id="dl-svg" onclick="downloadSVG()">
                        üì• SVG
                    </button>
                    <button id="dl-pdf">
                        üìÑ PDF
                    </button>
                </div>

                <div id="error-details" class="error-details">
                    <h3>‚ö†Ô∏è Error Details</h3>
                    <p id="error-message"></p>
                </div>
            </div>

            <div class="preview-container">
                <div id="preview">
                    <div class="preview-placeholder">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <rect x="3" y="3" width="18" height="18" rx="2"/>
                            <circle cx="12" cy="12" r="3"/>
                        </svg>
                        <div>Preview will appear here</div>
                        <div style="font-size: 0.8rem; margin-top: 0.5rem;">Enter dimensions and click Generate</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Application Script -->
    <script>
        // Global state
        const state = {
            pyodide: null,
            isGenerating: false,
            lastSVG: null
        };

        // DOM elements
        const elements = {
            status: document.getElementById('status'),
            statusText: document.getElementById('status-text'),
            genBtn: document.getElementById('gen-btn'),
            preview: document.getElementById('preview'),
            dlButtons: document.getElementById('dl-buttons'),
            errorDetails: document.getElementById('error-details'),
            errorMessage: document.getElementById('error-message'),
            lengthInput: document.getElementById('length'),
            widthInput: document.getElementById('width'),
            radiusInput: document.getElementById('radius')
        };

        /**
         * Updates the status bar UI
         */
        function setStatus(type, message) {
            elements.status.className = `status-bar ${type}`;
            elements.statusText.textContent = message;
        }

        /**
         * Shows error details in the UI
         */
        function showError(message) {
            elements.errorMessage.textContent = message;
            elements.errorDetails.classList.add('show');
            console.error('Application Error:', message);
        }

        /**
         * Hides error details
         */
        function hideError() {
            elements.errorDetails.classList.remove('show');
        }

        /**
         * Validates input dimensions
         */
        function validateInputs() {
            const length = parseFloat(elements.lengthInput.value);
            const width = parseFloat(elements.widthInput.value);
            const radius = parseFloat(elements.radiusInput.value);

            const errors = [];

            if (isNaN(length) || length <= 0) {
                errors.push('Length must be a positive number');
            }
            if (isNaN(width) || width <= 0) {
                errors.push('Width must be a positive number');
            }
            if (isNaN(radius) || radius <= 0) {
                errors.push('Hole radius must be a positive number');
            }

            if (errors.length === 0) {
                const minDim = Math.min(length, width);
                const maxRadius = minDim * 0.45;
                
                if (radius > maxRadius) {
                    errors.push(`Hole radius too large. Maximum: ${maxRadius.toFixed(1)}mm for ${length}x${width}mm plate`);
                }
            }

            return {
                valid: errors.length === 0,
                errors: errors
            };
        }

        /**
         * Initializes Pyodide and loads dependencies
         */
        async function initializePython() {
            try {
                setStatus('loading', 'Loading Python engine...');
                state.pyodide = await loadPyodide();

                setStatus('loading', 'Configuring package manager...');
                await state.pyodide.loadPackage('micropip');
                
                setStatus('loading', 'Installing CAD libraries (this may take a minute)...');
                await state.pyodide.runPythonAsync(`
                    import micropip
                    import sys

                    # Configure package sources
                    micropip.set_index_urls([
                        "https://yeicor.github.io/OCP.wasm",
                        "https://pypi.org/simple"
                    ])

                    # Install lib3mf
                    await micropip.install("lib3mf")
                    
                    # Mock py-lib3mf wrapper
                    micropip.add_mock_package(
                        "py-lib3mf", 
                        "2.4.1", 
                        modules={"py_lib3mf": "from lib3mf import *"}
                    )

                    # Install build123d and dependencies
                    await micropip.install([
                        "build123d",
                        "sqlite3",
                        "svgpathtools",
                        "numpy"
                    ])
                    
                    print("‚úÖ All packages installed successfully")
                `);

                setStatus('loading', 'Loading application logic...');
                
                // Try production path first, fall back to development path
                let logicCode;
                try {
                    const response = await fetch('./logic.py');
                    if (!response.ok) throw new Error('Not found in production path');
                    logicCode = await response.text();
                } catch (e) {
                    console.log('Trying development path...');
                    const response = await fetch('../src/logic.py');
                    if (!response.ok) {
                        throw new Error('Could not find logic.py in ./logic.py or ../src/logic.py');
                    }
                    logicCode = await response.text();
                }

                // Load the logic module
                state.pyodide.FS.writeFile('logic.py', logicCode);
                await state.pyodide.runPythonAsync(`
                    import logic
                    from logic import generate_plate_svg
                    print("‚úÖ Logic module loaded")
                `);

                // Ready!
                setStatus('ready', '‚úÖ Ready! Enter dimensions and click Generate');
                elements.genBtn.disabled = false;

            } catch (error) {
                setStatus('error', '‚ùå Initialization failed');
                showError(`Failed to initialize: ${error.message}`);
                throw error;
            }
        }

        /**
         * Generates the diagram
         */
        async function runGeneration() {
            if (state.isGenerating) return;

            // Validate inputs first
            const validation = validateInputs();
            if (!validation.valid) {
                showError(validation.errors.join('. '));
                return;
            }

            hideError();
            state.isGenerating = true;
            elements.genBtn.disabled = true;

            const length = elements.lengthInput.value;
            const width = elements.widthInput.value;
            const radius = elements.radiusInput.value;

            setStatus('generating', '‚öôÔ∏è Generating diagram...');
            
            try {
                const code = `logic.generate_plate_svg(${length}, ${width}, ${radius})`;
                const svgContent = await state.pyodide.runPythonAsync(code);

                if (!svgContent || !svgContent.trim()) {
                    throw new Error('Generated SVG is empty');
                }

                // Update preview
                elements.preview.innerHTML = svgContent;
                elements.preview.classList.add('has-content');
                elements.dlButtons.classList.add('show');
                
                state.lastSVG = svgContent;
                
                setStatus('ready', '‚úÖ Diagram generated successfully!');

            } catch (error) {
                setStatus('error', '‚ùå Generation failed');
                showError(`Generation error: ${error.message}`);
                console.error('Generation error:', error);
            } finally {
                state.isGenerating = false;
                elements.genBtn.disabled = false;
            }
        }

        /**
         * Downloads the generated SVG
         */
        function downloadSVG() {
            if (!state.lastSVG) {
                alert('Please generate a diagram first.');
                return;
            }

            try {
                const blob = new Blob([state.lastSVG], { type: 'image/svg+xml' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `plate_${elements.lengthInput.value}x${elements.widthInput.value}_r${elements.radiusInput.value}.svg`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            } catch (error) {
                alert(`Download failed: ${error.message}`);
            }
        }

        // Input validation on change
        [elements.lengthInput, elements.widthInput, elements.radiusInput].forEach(input => {
            input.addEventListener('input', () => {
                hideError();
            });
        });

        // Allow Enter key to trigger generation
        document.addEventListener('keypress', (e) => {
            if (e.key === 'Enter' && !elements.genBtn.disabled && !state.isGenerating) {
                runGeneration();
            }
        });

        // Initialize on load
        initializePython().catch(error => {
            console.error('Fatal initialization error:', error);
        });
    </script>

    <!-- PDF Export Module -->
    <script type="module">
        import { jsPDF } from "https://cdn.jsdelivr.net/npm/jspdf@2.5.1/+esm";
        import { svg2pdf } from "https://cdn.jsdelivr.net/npm/svg2pdf.js@2.2.4/+esm";

        document.getElementById('dl-pdf').addEventListener('click', async () => {
            const svgElement = document.querySelector('#preview svg');
            
            if (!svgElement) {
                alert('Please generate a diagram first.');
                return;
            }

            try {
                const doc = new jsPDF({
                    orientation: 'landscape',
                    unit: 'mm',
                    format: 'a4'
                });

                // Extract dimensions from SVG
                let width_mm = 200;
                let height_mm = 100;
                
                if (svgElement.viewBox && svgElement.viewBox.baseVal) {
                    width_mm = svgElement.viewBox.baseVal.width;
                    height_mm = svgElement.viewBox.baseVal.height;
                } else if (svgElement.getAttribute('width')) {
                    width_mm = parseFloat(svgElement.getAttribute('width')) || 200;
                    height_mm = parseFloat(svgElement.getAttribute('height')) || 100;
                }

                // Center on page
                const pageWidth = doc.internal.pageSize.getWidth();
                const pageHeight = doc.internal.pageSize.getHeight();
                const x = (pageWidth - width_mm) / 2;
                const y = (pageHeight - height_mm) / 2;

                await svg2pdf(svgElement, doc, {
                    x: Math.max(10, x),
                    y: Math.max(10, y),
                    width: width_mm,
                    height: height_mm
                });

                const length = document.getElementById('length').value;
                const width = document.getElementById('width').value;
                const radius = document.getElementById('radius').value;
                
                doc.save(`plate_${length}x${width}_r${radius}.pdf`);
                
            } catch (error) {
                console.error('PDF generation error:', error);
                alert(`PDF generation failed: ${error.message}`);
            }
        });
    </script>
</body>
</html>