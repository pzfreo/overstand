<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Violin Neck Geometry Generator</title>
    
    <!-- Pyodide -->
    <script src="https://cdn.jsdelivr.net/pyodide/v0.29.0/full/pyodide.js"></script>

    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background: linear-gradient(135deg, #8B4513 0%, #D2691E 100%);
            min-height: 100vh;
            padding: 1.5rem;
        }
        
        .app-container {
            max-width: 1400px;
            margin: 0 auto;
        }
        
        header {
            text-align: center;
            color: white;
            margin-bottom: 1.5rem;
        }
        
        h1 {
            font-size: 2.2rem;
            margin-bottom: 0.5rem;
            text-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }
        
        .subtitle {
            font-size: 1rem;
            opacity: 0.95;
        }
        
        .status-bar {
            background: white;
            padding: 12px 20px;
            border-radius: 8px;
            margin-bottom: 1.5rem;
            box-shadow: 0 4px 6px rgba(0,0,0,0.2);
            display: flex;
            align-items: center;
            gap: 10px;
            transition: all 0.3s ease;
        }
        
        .status-bar.loading { background: #fef3c7; color: #92400e; border-left: 4px solid #f59e0b; }
        .status-bar.ready { background: #d1fae5; color: #065f46; border-left: 4px solid #10b981; }
        .status-bar.error { background: #fee2e2; color: #991b1b; border-left: 4px solid #ef4444; }
        .status-bar.generating { background: #dbeafe; color: #1e40af; border-left: 4px solid #3b82f6; }
        
        .spinner {
            width: 16px;
            height: 16px;
            border: 2px solid currentColor;
            border-top-color: transparent;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
            display: none;
        }
        
        .status-bar.loading .spinner,
        .status-bar.generating .spinner { display: block; }
        
        @keyframes spin { to { transform: rotate(360deg); } }
        
        .main-container {
            background: white;
            border-radius: 12px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
            display: grid;
            grid-template-columns: 380px 1fr;
            gap: 0;
            overflow: hidden;
            max-height: calc(100vh - 200px);
        }
        
        @media (max-width: 1024px) {
            .main-container {
                grid-template-columns: 1fr;
                max-height: none;
            }
        }
        
        .controls-panel {
            background: #f9fafb;
            padding: 1.5rem;
            border-right: 1px solid #e5e7eb;
            overflow-y: auto;
            max-height: calc(100vh - 200px);
        }
        
        .preset-selector {
            margin-bottom: 1.5rem;
            padding: 1rem;
            background: white;
            border-radius: 8px;
            border: 2px solid #e5e7eb;
        }
        
        .preset-selector label {
            display: block;
            font-weight: 600;
            color: #374151;
            margin-bottom: 0.5rem;
            font-size: 0.875rem;
        }
        
        .preset-selector select {
            width: 100%;
            padding: 8px;
            border: 2px solid #d1d5db;
            border-radius: 6px;
            font-size: 0.95rem;
        }
        
        .category-section {
            margin-bottom: 1.5rem;
            background: white;
            border-radius: 8px;
            padding: 1rem;
            border: 1px solid #e5e7eb;
        }
        
        .category-title {
            font-weight: 700;
            color: #8B4513;
            margin-bottom: 0.75rem;
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            border-bottom: 2px solid #D2691E;
            padding-bottom: 0.5rem;
        }
        
        .param-group {
            margin-bottom: 1rem;
        }
        
        .param-group:last-child {
            margin-bottom: 0;
        }
        
        .param-label {
            display: flex;
            justify-content: space-between;
            align-items: baseline;
            margin-bottom: 0.4rem;
        }
        
        .param-label label {
            font-weight: 600;
            color: #374151;
            font-size: 0.85rem;
        }
        
        .param-unit {
            font-size: 0.75rem;
            color: #6b7280;
            font-weight: normal;
        }
        
        .param-description {
            font-size: 0.7rem;
            color: #6b7280;
            margin-top: 0.25rem;
            line-height: 1.3;
        }
        
        input[type="number"],
        input[type="range"],
        select {
            width: 100%;
            padding: 6px 8px;
            border: 2px solid #d1d5db;
            border-radius: 4px;
            font-size: 0.9rem;
            transition: border-color 0.2s;
        }
        
        input[type="number"]:focus,
        select:focus {
            outline: none;
            border-color: #8B4513;
        }
        
        input[type="range"] {
            padding: 0;
        }
        
        input[type="checkbox"] {
            width: 18px;
            height: 18px;
            margin-right: 8px;
        }
        
        .checkbox-group {
            display: flex;
            align-items: center;
        }
        
        .range-value {
            display: inline-block;
            min-width: 50px;
            text-align: right;
            font-size: 0.85rem;
            color: #374151;
            font-weight: 600;
        }
        
        .generate-btn {
            width: 100%;
            padding: 14px;
            background: linear-gradient(135deg, #8B4513 0%, #D2691E 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-weight: 700;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.2s;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-top: 1rem;
            box-shadow: 0 4px 6px rgba(139, 69, 19, 0.3);
        }
        
        .generate-btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(139, 69, 19, 0.4);
        }
        
        .generate-btn:disabled {
            background: #9ca3af;
            cursor: not-allowed;
            box-shadow: none;
        }
        
        .download-buttons {
            display: none;
            gap: 10px;
            margin-top: 10px;
        }
        
        .download-buttons.show {
            display: flex;
        }
        
        .download-buttons button {
            flex: 1;
            padding: 10px;
            border: none;
            border-radius: 6px;
            font-weight: 600;
            cursor: pointer;
            font-size: 0.9rem;
        }
        
        .btn-svg {
            background: #10b981;
            color: white;
        }
        
        .btn-pdf {
            background: #ef4444;
            color: white;
        }
        
        .preview-panel {
            padding: 2rem;
            display: flex;
            flex-direction: column;
            background: #fafafa;
        }
        
        #preview-container {
            flex: 1;
            border: 2px dashed #d1d5db;
            border-radius: 8px;
            background: white;
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 500px;
            overflow: auto;
        }
        
        #preview-container.has-content {
            border-style: solid;
            border-color: #8B4513;
        }
        
        #preview-container svg {
            max-width: 100%;
            max-height: 100%;
            filter: drop-shadow(0 4px 6px rgba(0,0,0,0.1));
        }
        
        .preview-placeholder {
            text-align: center;
            color: #9ca3af;
            padding: 2rem;
        }
        
        .preview-placeholder svg {
            width: 80px;
            height: 80px;
            margin-bottom: 1rem;
            opacity: 0.3;
        }
        
        .error-panel {
            background: #fee2e2;
            border: 2px solid #fecaca;
            border-radius: 8px;
            padding: 1rem;
            margin-top: 1rem;
            display: none;
        }
        
        .error-panel.show {
            display: block;
        }
        
        .error-panel h3 {
            color: #991b1b;
            font-size: 0.9rem;
            margin-bottom: 0.5rem;
        }
        
        .error-panel ul {
            list-style: none;
            padding: 0;
        }
        
        .error-panel li {
            color: #7f1d1d;
            font-size: 0.85rem;
            padding: 0.25rem 0;
            padding-left: 1.5rem;
            position: relative;
        }
        
        .error-panel li:before {
            content: "‚Ä¢";
            position: absolute;
            left: 0.5rem;
        }
    </style>
</head>
<body>
    <div class="app-container">
        <header>
            <h1>üéª Violin Neck Geometry Generator</h1>
            <p class="subtitle">Parametric CAD for Lutherie - Design precise neck templates based on historical and modern measurements</p>
        </header>

        <div id="status" class="status-bar loading">
            <div class="spinner"></div>
            <span id="status-text">Initializing Python environment...</span>
        </div>

        <div class="main-container">
            <div class="controls-panel">
                <div class="preset-selector">
                    <label for="preset">Quick Presets</label>
                    <select id="preset" onchange="loadPreset()">
                        <option value="">-- Custom --</option>
                    </select>
                </div>

                <div id="parameters-container">
                    <!-- Parameters will be generated here -->
                </div>

                <button class="generate-btn" id="gen-btn" disabled onclick="generateNeck()">
                    Generate Template
                </button>
                
                <div id="download-buttons" class="download-buttons">
                    <button class="btn-svg" onclick="downloadSVG()">üì• SVG</button>
                    <button class="btn-pdf" onclick="downloadPDF()">üìÑ PDF</button>
                </div>

                <div id="error-panel" class="error-panel">
                    <h3>‚ö†Ô∏è Validation Errors</h3>
                    <ul id="error-list"></ul>
                </div>
            </div>

            <div class="preview-panel">
                <div id="preview-container">
                    <div class="preview-placeholder">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M12 2L2 7v10c0 5.55 3.84 10.74 9 12 5.16-1.26 9-6.45 9-12V7l-10-5z"/>
                            <circle cx="12" cy="12" r="3"/>
                        </svg>
                        <div style="font-size: 1.1rem; font-weight: 600; margin-bottom: 0.5rem;">
                            Neck Template Preview
                        </div>
                        <div style="font-size: 0.9rem;">
                            Adjust parameters and click Generate
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Application Script -->
    <script>
        // Global state
        const state = {
            pyodide: null,
            isGenerating: false,
            lastSVG: null,
            parameterDefinitions: null,
            presets: null
        };

        const elements = {
            status: document.getElementById('status'),
            statusText: document.getElementById('status-text'),
            genBtn: document.getElementById('gen-btn'),
            preview: document.getElementById('preview-container'),
            downloadButtons: document.getElementById('download-buttons'),
            errorPanel: document.getElementById('error-panel'),
            errorList: document.getElementById('error-list'),
            parametersContainer: document.getElementById('parameters-container'),
            presetSelect: document.getElementById('preset')
        };

        function setStatus(type, message) {
            elements.status.className = `status-bar ${type}`;
            elements.statusText.textContent = message;
        }

        function showErrors(errors) {
            elements.errorList.innerHTML = errors.map(e => `<li>${e}</li>`).join('');
            elements.errorPanel.classList.add('show');
        }

        function hideErrors() {
            elements.errorPanel.classList.remove('show');
        }

        async function initializePython() {
            try {
                setStatus('loading', 'Loading Python engine...');
                state.pyodide = await loadPyodide();

                setStatus('loading', 'Installing package manager...');
                await state.pyodide.loadPackage('micropip');
                
                setStatus('loading', 'Installing CAD libraries (this may take 1-2 minutes)...');
                await state.pyodide.runPythonAsync(`
                    import micropip
                    
                    micropip.set_index_urls([
                        "https://yeicor.github.io/OCP.wasm",
                        "https://pypi.org/simple"
                    ])
                    
                    await micropip.install("lib3mf")
                    micropip.add_mock_package(
                        "py-lib3mf", 
                        "2.4.1", 
                        modules={"py_lib3mf": "from lib3mf import *"}
                    )
                    
                    await micropip.install([
                        "build123d",
                        "sqlite3",
                        "svgpathtools",
                        "numpy"
                    ])
                    
                    print("‚úÖ Packages installed")
                `);

                setStatus('loading', 'Loading violin neck modules...');
                
                // Load Python modules
                const modules = ['violin_parameters.py', 'violin_geometry.py', 'violin_generator.py'];
                
                for (const moduleName of modules) {
                    let response = await fetch(`./${moduleName}`);
                    if (!response.ok) {
                        response = await fetch(`../src/${moduleName}`);
                    }
                    if (!response.ok) {
                        throw new Error(`Could not find ${moduleName}`);
                    }
                    
                    const code = await response.text();
                    state.pyodide.FS.writeFile(moduleName, code);
                }

                // Import modules
                await state.pyodide.runPythonAsync(`
                    import violin_parameters
                    import violin_geometry
                    import violin_generator
                    print("‚úÖ Modules loaded")
                `);

                // Get parameter definitions
                setStatus('loading', 'Building interface...');
                const paramDefsJson = await state.pyodide.runPythonAsync(`
                    from violin_generator import get_parameter_definitions
                    get_parameter_definitions()
                `);
                
                state.parameterDefinitions = JSON.parse(paramDefsJson);
                
                // Get presets
                const presetsJson = await state.pyodide.runPythonAsync(`
                    from violin_generator import get_presets
                    get_presets()
                `);
                
                state.presets = JSON.parse(presetsJson);
                
                // Generate UI
                generateUI();
                populatePresets();

                setStatus('ready', '‚úÖ Ready! Adjust parameters and generate your template');
                elements.genBtn.disabled = false;

            } catch (error) {
                setStatus('error', '‚ùå Initialization failed');
                showErrors([`Failed to initialize: ${error.message}`]);
                console.error('Initialization error:', error);
            }
        }

        function generateUI() {
            const container = elements.parametersContainer;
            container.innerHTML = '';

            const categories = state.parameterDefinitions.categories;
            const parameters = state.parameterDefinitions.parameters;

            for (const category of categories) {
                const section = document.createElement('div');
                section.className = 'category-section';
                
                const title = document.createElement('div');
                title.className = 'category-title';
                title.textContent = category;
                section.appendChild(title);

                for (const [name, param] of Object.entries(parameters)) {
                    if (param.category === category) {
                        section.appendChild(createParameterControl(name, param));
                    }
                }

                container.appendChild(section);
            }
        }

        function createParameterControl(name, param) {
            const group = document.createElement('div');
            group.className = 'param-group';

            if (param.type === 'number') {
                const labelDiv = document.createElement('div');
                labelDiv.className = 'param-label';
                
                const label = document.createElement('label');
                label.textContent = param.label;
                label.htmlFor = name;
                
                const unit = document.createElement('span');
                unit.className = 'param-unit';
                unit.textContent = param.unit;
                
                labelDiv.appendChild(label);
                labelDiv.appendChild(unit);
                group.appendChild(labelDiv);

                const input = document.createElement('input');
                input.type = 'number';
                input.id = name;
                input.name = name;
                input.value = param.default;
                input.min = param.min;
                input.max = param.max;
                input.step = param.step;
                input.addEventListener('change', hideErrors);
                group.appendChild(input);

            } else if (param.type === 'enum') {
                const labelDiv = document.createElement('div');
                labelDiv.className = 'param-label';
                
                const label = document.createElement('label');
                label.textContent = param.label;
                label.htmlFor = name;
                labelDiv.appendChild(label);
                group.appendChild(labelDiv);

                const select = document.createElement('select');
                select.id = name;
                select.name = name;
                
                for (const option of param.options) {
                    const opt = document.createElement('option');
                    opt.value = option.value;
                    opt.textContent = option.label;
                    if (option.value === param.default) {
                        opt.selected = true;
                    }
                    select.appendChild(opt);
                }
                
                select.addEventListener('change', hideErrors);
                group.appendChild(select);

            } else if (param.type === 'boolean') {
                const checkboxDiv = document.createElement('div');
                checkboxDiv.className = 'checkbox-group';
                
                const input = document.createElement('input');
                input.type = 'checkbox';
                input.id = name;
                input.name = name;
                input.checked = param.default;
                input.addEventListener('change', hideErrors);
                
                const label = document.createElement('label');
                label.textContent = param.label;
                label.htmlFor = name;
                
                checkboxDiv.appendChild(input);
                checkboxDiv.appendChild(label);
                group.appendChild(checkboxDiv);
            }

            if (param.description) {
                const desc = document.createElement('div');
                desc.className = 'param-description';
                desc.textContent = param.description;
                group.appendChild(desc);
            }

            return group;
        }

        function populatePresets() {
            const select = elements.presetSelect;
            
            for (const [name, values] of Object.entries(state.presets)) {
                const option = document.createElement('option');
                option.value = name;
                option.textContent = name.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
                select.appendChild(option);
            }
        }

        function loadPreset() {
            const presetName = elements.presetSelect.value;
            if (!presetName) return;

            const preset = state.presets[presetName];
            if (!preset) return;

            // Apply preset values
            for (const [name, value] of Object.entries(preset)) {
                const element = document.getElementById(name);
                if (element) {
                    if (element.type === 'checkbox') {
                        element.checked = value;
                    } else {
                        element.value = value;
                    }
                }
            }

            hideErrors();
        }

        function collectParameters() {
            const params = {};
            
            for (const [name, param] of Object.entries(state.parameterDefinitions.parameters)) {
                const element = document.getElementById(name);
                if (!element) continue;

                if (param.type === 'number') {
                    params[name] = parseFloat(element.value);
                } else if (param.type === 'boolean') {
                    params[name] = element.checked;
                } else if (param.type === 'enum') {
                    params[name] = element.value;
                }
            }

            return params;
        }

        async function generateNeck() {
            if (state.isGenerating) return;

            hideErrors();
            state.isGenerating = true;
            elements.genBtn.disabled = true;

            setStatus('generating', '‚öôÔ∏è Generating neck template...');

            try {
                const params = collectParameters();
                const paramsJson = JSON.stringify(params);

                const resultJson = await state.pyodide.runPythonAsync(`
                    from violin_generator import generate_violin_neck
                    generate_violin_neck('${paramsJson.replace(/'/g, "\\'")}')
                `);

                const result = JSON.parse(resultJson);

                if (result.success) {
                    elements.preview.innerHTML = result.svg;
                    elements.preview.classList.add('has-content');
                    elements.downloadButtons.classList.add('show');
                    state.lastSVG = result.svg;
                    setStatus('ready', '‚úÖ Template generated successfully!');
                } else {
                    showErrors(result.errors);
                    setStatus('error', '‚ùå Generation failed - see errors below');
                }

            } catch (error) {
                showErrors([`Unexpected error: ${error.message}`]);
                setStatus('error', '‚ùå Generation failed');
                console.error('Generation error:', error);
            } finally {
                state.isGenerating = false;
                elements.genBtn.disabled = false;
            }
        }

        function downloadSVG() {
            if (!state.lastSVG) return;

            const blob = new Blob([state.lastSVG], { type: 'image/svg+xml' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'violin_neck_template.svg';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        function downloadPDF() {
            alert('PDF export will be implemented with jsPDF');
        }

        // Initialize on load
        initializePython();
    </script>

    <!-- PDF Export (optional) -->
    <script type="module">
        import { jsPDF } from "https://cdn.jsdelivr.net/npm/jspdf@2.5.1/+esm";
        import { svg2pdf } from "https://cdn.jsdelivr.net/npm/svg2pdf.js@2.2.4/+esm";

        window.downloadPDF = async function() {
            const svgElement = document.querySelector('#preview-container svg');
            
            if (!svgElement) {
                alert('Please generate a template first.');
                return;
            }

            try {
                const doc = new jsPDF({
                    orientation: 'portrait',
                    unit: 'mm',
                    format: 'a4'
                });

                await svg2pdf(svgElement, doc, {
                    x: 10,
                    y: 10,
                    width: 190,
                    height: 277
                });

                doc.save('violin_neck_template.pdf');
                
            } catch (error) {
                console.error('PDF error:', error);
                alert(`PDF generation failed: ${error.message}`);
            }
        };
    </script>
</body>
</html>